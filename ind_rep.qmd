---
title: "Citi Bike Usage in NYC: Individual Report"
author: "Karen Cruz"
execute:
  freeze: true
---

## 1. Introduction

Among the multiple systems of transportation, bike-share systems have become a vital component of urban networks. Offering flexible, low-emission travel options for commuters and recreational users in New York City, Citi Bike has emerged as the largest bike-share system in the U.S., Manhattan accounting a large share of total ridership due to the borough's density, employment concentration, and extensive station coverage.

Our study addresses the overarching question:

> *Among time, location, and other rider characteristics, which variables are the most important drivers of Citi Bike trip volume in Manhattan?*

As an initial step toward addressing the broader question, this analysis examines a related sub-question:

> **“How do time of day and day of the week affect Citi Bike ridership?”**

Temporal factors are widely recognized as strong predictors of transportation demand, especially in commuted-focused settings. By isolating Manhattan and analyzing hourly and weekly patterns, this study aims to measure the magnitude and consistency of time-based influences, highlighting their significance compared to other potential determinants.

------------------------------------------------------------------------

## 2. Literary Review

Based on previous research on bike-share patterns and ridership, observations are consistent, including weekday commuting peaks and season variation. Multiple studies of Citi Bike data indicate that time-of-day and day-of-week explain a larger share of ridership variation compared to other individual rider characteristics.

Analyses using Citi Bike data similarly highlight such importance of temporal effects. The NYC Data Science project [Inferential Analysis on Citi Bike Ridership](https://nycdatascience.com/blog/student-works/inferential-analysis-on-citi-bike-ridership/) applies statistical modeling techniques to identify key determinants of usage to explain a substantial portion of ridership variation. Although this work provides valuable system-wide insights, its overall approach may obscure meaningful spatial differences within NYC, particularly between boroughs with distinct travel behaviors and infrastructure characteristics.

The [ScienceDirect](https://doi.org/10.1016/j.jtrangeo.2024.103799) study reinforces the conclusion about temporal variables. Their inferential analysis shows that the same variables emerge as significant predictors, even when controlling other factors. Once again, this highlights the importance of temporal regularity in bike share usage.

------------------------------------------------------------------------

## 3. Data and Methods

```{r}
#| label: Citi Bike data download
#| include: false
## Install packages 

library(data.table)
library(sf)
library(utils)


## Directories 

raw_dir <- "data/raw"          # for zip files 
out_dir <- "data/processed"    # where final RDS will be saved
gis_dir <- "data/gis"          # location of borough shapefile

dir.create(raw_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(gis_dir, showWarnings = FALSE, recursive = TRUE)


## increase timeout + stable download 

options(timeout = max(1200, getOption("timeout")))          
options(download.file.method = "libcurl")                   


## Months + base URL

months <- format(
  seq(as.Date("2024-10-01"), as.Date("2025-10-01"), by = "month"),
  "%Y%m"
)

base_url <- "https://s3.amazonaws.com/tripdata"

## 1) Download and prepare Manhattan GIS polygon 

# NYC DCP borough boundary URL + store path of borough 
borough_url <- "https://www.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_16a.zip"
borough_zip <- file.path(gis_dir, "nyc_boroughs.zip")

# Download only if missing
if (!file.exists(borough_zip)) {
  message("Downloading NYC borough boundaries shapefile...")
  download.file(borough_url, borough_zip, mode = "wb")
} else {
  message("Borough ZIP already exists — skipping download.")
}

# Unzip only if no shapefile exists
existing_shp <- list.files(
  gis_dir, 
  pattern = "\\.shp$", 
  recursive = TRUE,
  full.names = TRUE
) 

if (length(existing_shp) == 0) {
  message("Unzipping borough shapefile...")
  unzip(borough_zip, exdir = gis_dir)
} else {
  message("Shapefile already present — skipping unzip.")
}

shp_file <- list.files(
  gis_dir,
  pattern = "\\.shp$",
  recursive = TRUE,
  full.names = TRUE
)[1]

boroughs <- st_read(shp_file, quiet = TRUE)
boroughs <- st_transform(boroughs, 4326)

manhattan_poly <- boroughs[boroughs$BoroName == "Manhattan", ]

## 2) Download Citi Bike data 

download_zip <- function(m) {
  zip_name <- sprintf("%s-citibike-tripdata.zip", m)
  zip_path <- file.path(raw_dir, zip_name)
  zip_url  <- paste0(base_url, "/", zip_name)
  
  if (file.exists(zip_path)) {
    message("ZIP exists, skipping download: ", zip_name)
    return(zip_path)
  }
  
  message("Downloading ZIP once: ", zip_name)
  download.file(zip_url, zip_path, mode = "wb")
  
  return(zip_path)
}

## 3) Month processor with GIS-based Manhattan filter 

process_month_manhattan <- function(m, delete_zip = TRUE) {
  
  month_rds <- file.path(out_dir, paste0("manhattan_", m, ".rds"))
  
  # SKIP if processed already
  if (file.exists(month_rds)) {
    message("Already processed — loading: ", m)
    return(readRDS(month_rds))
  }
  
  zip_path <- download_zip(m)
  
  message("\n=== Processing month: ", m, " ===")
  
  # TEMP UNZIP (AUTOMATICALLY CLEANED)
  tmpdir <- file.path(tempdir(), m)
  dir.create(tmpdir, showWarnings = FALSE)
  unzip(zip_path, exdir = tmpdir)
  
  csv_files <- list.files(tmpdir, pattern = "\\.csv$", full.names = TRUE)
  if (length(csv_files) == 0) {
    unlink(tmpdir, recursive = TRUE)
    stop("No CSV files found in ZIP for month ", m)
  }
  
  # PROCESS ALL CSVs
  month_list <- vector("list", length(csv_files))
  
  for (i in seq_along(csv_files)) {
    csv <- csv_files[i]
    
    dt <- fread(csv, select = c(
      "ride_id","rideable_type","started_at","ended_at",
      "start_station_name","start_station_id",
      "end_station_name","end_station_id",
      "start_lat","start_lng","end_lat","end_lng",
      "member_casual"
    ))
    
    dt[, started_at := as.POSIXct(started_at, tz = "America/New_York")]
    dt[, ended_at   := as.POSIXct(ended_at,   tz = "America/New_York")]
    
    # STRICT filter — prevents 202409 rides from being included 
    dt <- dt[started_at >= as.POSIXct("2024-10-01 00:00:00", tz = "America/New_York")]
    
    # Date/hour fields
    dt[, date := as.Date(started_at)]
    dt[, hour := as.integer(format(started_at, "%H"))]
    
    # Remove missing coords
    dt <- dt[!is.na(start_lat) & !is.na(start_lng)]
    
    # Spatial filter
    dt_sf <- st_as_sf(dt, coords = c("start_lng", "start_lat"), crs = 4326, remove = FALSE)
    inside <- st_within(dt_sf, manhattan_poly, sparse = FALSE)[,1]
    
    dt_man <- as.data.table(st_drop_geometry(dt_sf[inside, ]))
    month_list[[i]] <- dt_man
  }
  
  month_all <- rbindlist(month_list, use.names = TRUE, fill = TRUE)
  
  # SAVE (restart safety)
  saveRDS(month_all, month_rds)
  message("Saved month RDS: ", month_rds)
  
  # REMOVE TEMPORARY UNZIP
  unlink(tmpdir, recursive = TRUE)
  
  # DELETE ZIP FILE AFTER PROCESSING (MAX STORAGE SAVINGS)
  if (delete_zip) {
    file.remove(zip_path)
    message("Deleted ZIP to save space: ", basename(zip_path))
  }
  
  return(month_all)
}

## 4) Run over all months 

all_months_list <- vector("list", length(months))

for (i in seq_along(months)) {
  m <- months[i]
  month_all <- process_month_manhattan(m)
  all_months_list[[i]] <- month_all
  rm(month_all)
  gc()
}

all_months_list <- lapply(months, process_month_manhattan)

final_path <- file.path(out_dir, "citibike_manhattan_all_202410_202510.rds")

if (!file.exists(final_path)) {
  final <- rbindlist(all_months_list, use.names = TRUE, fill = TRUE)
  saveRDS(final, final_path)
  message("Saved FINAL combined dataset.")
} else {
  message("Final dataset already exists — skipping rebuild.")
}
```

### 3.1 Data Sources

**Citi Bike Trip Data**

This study uses monthly trip-level data from October 2024 through October 2025. The dataset provides detailed records including the trip's start time, station information, geographic coordinates, and rider classification (member or casual). It offers high temporal resolution and comprehensive coverage of bikeshare activity across New York City, making them well suited for analyzing short-term incurring temporal patterns in ridership.

The analysis of the specific question focuses specifically on trip start times, as this best reflects rider decision-making and demand for bikeshare services. Using such trip-level data allows for more flexible aggregation across varying temporal scales while preserving the underlying structure of usage patterns.

### 3.2 Data Processing

```{r}
#| message: false
library(ggplot2)
library(scales)
library(lubridate)
library(ggtext)
library(broom)

citibike <- readRDS(
  "data/processed/citibike_manhattan_all_202410_202510.rds"
)

# REMOVE September 2024 completely
citibike <- citibike[format(date, "%Y-%m") != "2024-09"]

# Re-create time variables AFTER filtering
citibike[, month := format(date, "%Y-%m")]
citibike[, dow := wday(date, label = TRUE, week_start = 1)]
citibike[, wknd := ifelse(dow %in% c("Sat", "Sun"), "Weekend", "Weekday")]
```

Several processing steps were applied to prepare the Citi Bike data for analysis. First, trips were filtered to only include rides starting in Manhattan. By using spatial containment with borough boundary shape-files, it ensured that only trips with starting coordinated falling within the Manhattan borough polygon were retained. This is a crucial step to focus on Manhattan and remove any trips originating in other boroughs.

To further restrict the defined study period, September 2024 had to be manually removed. Although the study period starts on October 2024, September 2024 appeared as a spillover record due late-night and delayed trips included in October 2024 Citi Bike release. Since the month was incomplete, it was excluded to maintain temporal consistency.

From the cleaned data, multiple temporal variables were created:

-   Hour of Day (hour)

-   Month (month)

-   Day of week (dow)

-   Weekend indicator (wknd)

-   Centered hour (hour_c)

-   Hour fixed effects (factor(hour)) 

Aggregating trips to hourly and daily counts, reducing noise inherent individual trip records, and enabling clearer visualization and interpretable temporal modeling. These steps were necessary and appropriate for identifying systematic patterns in bike-share usage, while also retaining sufficient temporal detail for meaningful analysis.

### 3.3 Analytic Approach

#### Exploratory Data Analysis (EDA)

```{r}
#| label: Weekday vs Weekend Hourly Patterns
#| echo: true
#| message: false
#| warning: false

hour_wknd <- citibike[
  ,
  .(N = .N),
  by = .(month, hour, wknd)
]

ggplot(hour_wknd, aes(x = hour, y = N, color = wknd)) +
  geom_line(linewidth = 1) +
  facet_wrap(~ month) +
  labs(
    title = "**Hourly Ridership Patterns: Weekday vs Weekend**",
    x = "Hour",
    y = "Trips",
    color = "",
    caption = "Data from Citi Bike (Manhattan starts only)"
  ) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(0, 23, by = 3)) +
  theme_minimal() +
  theme(
    plot.title = element_markdown(),
    legend.position = "top",
    panel.spacing = unit(1, "lines")
  )
```

**Figure 1. Weekdays vs. Weekend Patterns.**

Hourly ridership was compared between weekdays and weekends to distinguish commute-oriented usage from leisure-oriented travel, revealing weekday peaks and flatter weekend trends.

```{r}
#| label: Heatmap
#| echo: true
#| message: false
#| warning: false
heatmap_dt <- citibike[
  ,
  .(N = .N),
  by = .(dow, hour)
]

ggplot(heatmap_dt, aes(x = hour, y = dow, fill = N)) +
  geom_tile() +
  labs(
    title = "**Hourly Ridership by Day of Week**",
    x = "Hour of Day",
    y = "",
    fill = "Trips"
  ) +
  scale_fill_viridis_c(labels = comma) +
  scale_x_continuous(breaks = seq(0, 23, 3)) +
  theme_minimal() +
  theme(plot.title = element_markdown())
```

**Figure 2. Hour x Day-of-Week Heat Map.**

This heat map was used to visualize hourly and weekly ridership intensity for Manhattan. Weekends display strong daytime and commute peaks, while weekends exhibit flatter, more evenly distributed ridership patterns consistent with non-commuting travel.

```{r}
#| label: Regression
#| echo: true
#| message: false
#| warning: false

hourly_counts <- citibike[
  ,
  .N,
  by = .(date, hour, wknd)
]

hourly_counts[, peak := hour %in% c(7:9, 16:18)]

avg_hourly <- hourly_counts[
  ,
  .(avg_hourly_trips = mean(N)),
  by = wknd
]

weekday_avg <- avg_hourly[wknd == "Weekday", avg_hourly_trips]

avg_hourly[
  ,
  pct_diff_vs_weekday :=
    (avg_hourly_trips - weekday_avg) / weekday_avg * 100
]

peak_stats <- hourly_counts[
  ,
  .(avg_trips = mean(N)),
  by = .(wknd, peak)
]

peak_stats[, peak := ifelse(peak, "Peak Hours", "Off-Peak Hours")]

peak_share <- hourly_counts[
  ,
  .(total_trips = sum(N)),
  by = .(wknd, peak)
][
  ,
  share_of_trips := total_trips / sum(total_trips),
  by = wknd
][
  peak == TRUE,
  .(wknd, share_of_peak_trips = share_of_trips)
]

summary_table <- merge(
  avg_hourly[, .(wknd, avg_hourly_trips, pct_diff_vs_weekday)],
  peak_stats[peak == "Peak Hours", .(wknd, peak_avg_trips = avg_trips)],
  by = "wknd"
)

summary_table <- merge(
  summary_table,
  peak_share,
  by = "wknd"
)

summary_table <- merge(
  avg_hourly[, .(wknd, avg_hourly_trips, pct_diff_vs_weekday)],
  peak_stats[peak == "Peak Hours", .(wknd, peak_avg_trips = avg_trips)],
  by = "wknd"
)

summary_table <- merge(
  summary_table,
  peak_share,
  by = "wknd"
)

summary_table[
  ,
  `:=`(
    avg_hourly_trips = round(avg_hourly_trips),
    pct_diff_vs_weekday = round(pct_diff_vs_weekday, 1),
    peak_avg_trips = round(peak_avg_trips),
    share_of_peak_trips = round(share_of_peak_trips * 100, 1)
  )
]

library(knitr)
library(kableExtra)

summary_table_pretty <- copy(summary_table)

# Rename columns for readability
setnames(
  summary_table_pretty,
  old = c("wknd",
          "avg_hourly_trips",
          "pct_diff_vs_weekday",
          "peak_avg_trips",
          "share_of_peak_trips"),
  new = c("Day Type",
          "Average Hourly Trips",
          "% Difference vs Weekday",
          "Peak-Hour Avg Trips",
          "Share of Trips During Peak Hours (%)")
)

kable(
  summary_table_pretty,
  format = "html",
  digits = 1,
  caption = "Summary of Hourly Citi Bike Ridership by Day Type (Manhattan)"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE,
    position = "center"
  )

```

#### Regression Modeling

```{r}
#| label: Regression
#| echo: false
#| warning: false

hourly_counts[, hour_c := hour - mean(hour)]

model <- lm(N ~ factor(hour) + wknd, data = hourly_counts)


coef_df <- broom::tidy(model, conf.int = TRUE)
coef_df$hour_num <- as.numeric(gsub("factor\\(hour\\)", "", coef_df$term))
coef_df <- coef_df[order(coef_df$hour_num, decreasing = TRUE), ]
coef_df <- coef_df[coef_df$term != "(Intercept)", ]

coef_df$term <- ifelse(
  coef_df$term == "wkndWeekend",
  "Weekend (vs Weekday)",
  paste0("Hour ", coef_df$hour_num)
)

ggplot(coef_df, aes(x = estimate, y = term)) +
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "**Regression Coefficients: Hour & Weekend Effects**",
    x = "Estimate",
    y = ""
  ) +
  theme_minimal() +
  theme(plot.title = element_markdown())
```

**Figure 3. Regression Coefficients for Hour-of-day and Weekend Effects.**

Coefficient estimated from a linear regression of hourly Citi Bike trip counts in Manhattan, using hour-of-day fixed effects and a weekend indicator.

```{r}
#| label: regression table
#| echo: true
#| message: false
#| warning: false
# Tidy regression output
reg_table <- broom::tidy(model, conf.int = TRUE)

# Drop everything except weekend effect
reg_table <- reg_table[reg_table$term == "wkndWeekend", ]


# Add model-level statistics
model_glance <- glance(model)

reg_summary <- data.table(
  Term = "Weekend (vs Weekday)",
  Estimate = round(reg_table$estimate, 1),
  `95% CI` = paste0(
    round(reg_table$conf.low, 1), ", ",
    round(reg_table$conf.high, 1)
  ),
  `p-value` = round(reg_table$p.value, 3),
  `R-squared` = round(model_glance$r.squared, 3),
  `Observations` = model_glance$nobs
)

kable(
  reg_summary,
  caption = "Regression Results: Weekend Effect on Hourly Citi Bike Ridership",
  align = "c"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover"),
    full_width = FALSE
  )
```

**Table 1. Summary Statistics.**

Highlights differences between weekend and weekday usage in Manhattan.

------------------------------------------------------------------------

## 4. Results

### 4.1 Time-of-Day Patterns

### 4.2 Day-of-Week Patterns

### 4.3 Regression Findings

------------------------------------------------------------------------

## 5. Discussion

This study analysis showed that Citi Bike usage in Manhattan is strongly shaped by temporal factors, time of day and day of the week, with various visualizations, summary statistics, and modeling approaches. Instead of treating time like a secondary control variable, these results indicate that both factors are fundamental drivers of bike share demand. Throughout the study period, the results remained consistent and stable, suggesting that ridership behavior is governed by more recurring daily routines rather than short-term fluctuations.

Weekday usage trends closely mirror standard commuting patterns, highlighting Citi Bike’s role as a practical transportation option within Manhattan’s dense urban landscape. The indications of strong daytime usage and commuting-related peaks support the claim that riders choose this mode of transportation to rely on Citi Bike for predictable, routine travel. As we have noted earlier, weekend ridership displays a different temporal profile in comparison. It is marked by lower ridership levels and a higher concentration of activity during a limited number of daytime hours. This reveals a shift from schedule driven travel to more discretionary use.

The regression findings reinforce the noted interpretations by isolating the independent effect weekend status has, while also controlling hour-of-the-day variance. The consistent negative weekend effect implies that temporal context—whether a trip occurs on a weekday or weekend—alters ridership levels even at identical hours. Furthermore, the combined use of descriptive and inferential methods enhances confidence in these conclusions by showing consistency across multiple analytic approaches.

Overall, the analysis focuses on the importance of modeling time when interpreting bike share systems. If hour-of-day and time-of-day or weekend/weekday distinctions are removed from the model, it will reduce the explanatory power of models and obscure any meaningful behavioral differences. These findings carry significant implications for transportation planning, operational strategies, and demand forecasting for the urban core that Manhattan is.

------------------------------------------------------------------------

## 6. Limitations

The focus of this study is Manhattan exclusively without generalizing the findings to other boroughs with different land-use patterns. Additionally, the purpose of each individual trip cannot be derived from the Citi Bike data, requiring us to infer commuting and leisure behavior. While aggregating trips to hourly and daily counts is necessary for visualization and modeling, it can obscure other detailed temporal dynamics that are present in individual trip records. Relying on a single year of data ultimately limits the ability to assess long-term trends or any structural changes in Citi Bike usage over time.

Despite these limitations, the findings provide evidence that these variables play a central role in shaping bike usage. While the research and analysis are appropriate for this study, our potential future work will incorporate other data to further expand the analysis to other boroughs.

------------------------------------------------------------------------

## 7. Conclusion

Across cities, bike-share usage typically follows a stable temporal structure. Weekday ridership is driven by routine commuting patterns, while weekend usage reflects leisure patterns with lower, more discretionary demand. These results demonstrate that time-based variables are essential for understanding and modeling ridership variation.
